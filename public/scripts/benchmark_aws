#!/bin/sh
apt-get update
it=`curl -s http://169.254.169.254/latest/meta-data/instance-type`
az=`curl -s http://169.254.169.254/latest/meta-data/placement/availability-zone`
apt-get install -y build-essential sysbench gnuplot liblist-moreutils-perl libreadonly-perl

report=/tmp/bench_result.log

echo "=============================================================" > $report
echo "Test report of $it-$az" >> $report
echo "=============================================================" >> $report
echo "Network Performance test" >> $report
wget -O - https://raw.github.com/sivel/speedtest-cli/master/speedtest_cli.py | python >> $report
echo "=============================================================" >> $report
echo "CPU test" >> $report
ncpu=`nproc`
sysbench --test=cpu --num-threads=${ncpu} run >> $report
echo "=============================================================" >> $report
echo "Memory test" >> $report
sysbench --test=memory --num-threads=${ncpu} run >> $report
echo "=============================================================" >> $report
echo "FileIO prepare" >> $report
sysbench --test=fileio --file-total-size=100G prepare >> $report
for t in seqwr seqrewr seqrd rndrd rndwr rndrw
do
  echo "=============================================================" >> $report
  echo "File IO $t" >> $report
  sysbench --test=fileio --num-threads=${ncpu} --file-test-mode=$t run >> $report
done
echo "=============================================================" >> $report




wget http://www.iozone.org/src/current/iozone3_434.tar
tar xvf iozone3_434.tar
cd iozone3_434/src/current
make linux
./iozone -a >> ./iozone.out
perl iozone_visualizer.pl iozone.out
tar zcvf report_iozone.tgz report_iozone
